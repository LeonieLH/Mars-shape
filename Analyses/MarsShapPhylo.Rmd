---
title: "Marsupial shape and phylogenetics"
author: "Leonie Lange-Hodgson"
date: "22 January 2019"
output: html_document
---


# load required libraries

#I will be using the following R packages in these analyses; geomorph, ape, plyr, abind, and geiger.

```{r}

library(geomorph)
library(ape)
library(plyr)
library(abind)
library(geiger)

```
#read in coordinates

#Prior to investigating the three predictions of this study, I will input andprepare my data.
```{r}

#RUN LINE BY LINE! LATER DOWN THE LINE ASK THOMAS HOW TO FIX THIS

#This working directory needs to be set for this chunk because otherwise it won't find the files. It is an issue of rmd talking to R itself.
setwd("E:/Github_Projects/Mars-shape/Data/Raw/Coordinates") #Vera's computer
setwd("D:/Github_Projects/Mars-shape/Data/Raw/Coordinates")  #Leonie's computer


filelist <- list.files(path= "../Data/Raw/Coordinates", pattern = "*.txt")

#Next step is to remove the Museum IDs from the specimen names   
  
  tmp <- matrix(unlist(strsplit(filelist, "_")),ncol=3,byrow = TRUE)   

  filelist_species <- paste(tmp[,1], tmp[,2], sep="_")

  
  names <- gsub (".txt", "", filelist) # extracts names of specimens from the file name
  filelist <- paste("../Data/Raw/Coordinates/", filelist, sep="") # rename with path
  coords <- NULL # make empty object that will be filled with 3D array of coordinate data
  for (i in 1:length(filelist)){
    temp  <- read.morphologika(filelist[i]) 
    k <- dim(temp)[1] 
    coords <- rbind(coords, two.d.array(temp)) }
  Data <- arrayspecs(coords, k, 3) 
  dimnames(Data)[[3]] <- filelist_species
  remove(i, filelist, names, k, coords, temp) # clean up environment
  
  #Double check that the 3D info is entered properly
  plot3d(Data[,,5], asp=FALSE)
  text3d(Data[,,5], texts=c(1:71))

  
  
```

#Continuing data preparation, the function 'gpagen' will run a Generalised Procrustes Analysis (GPA). GPA will take the specimen landmarks and superimpose them, thereby removing all the differences in size, orientation and location between each specimen. What remains are landmark coordinates tha provide the shape variation between species.
#This will make it possible to allow me to analyse their shape variation relative to each other

#GPA - 
```{r}
#Run GPA
GPA <- gpagen(Data)


```



#AVERAGING MULTIPLE SPECIMENS OF ONE SPECIES

#Two of the species in this dataset have multiple specimens which means they must be averaged prior to analysis. Once this is performed, GPA must be run again to incorporate these changes (SHOULD I JUST AVERAGE THE SPECIES FIRST THEN GPA? WITHOUT DOING THE ABOVE GPA?)

```{r}
#There are multiple specimens of the same species. This means they need to be averaged before continuing 

# shape data
ind.coords <- aggregate(two.d.array(GPA$coords) ~ dimnames(GPA$coords)[[3]], FUN=mean)[,-1]
rownames(ind.coords) <- unique(dimnames(GPA$coords)[[3]])
ind.coords <- arrayspecs(ind.coords, p=ncol(ind.coords)/3, k=3)
# centroid size data
ind.Csize <- as.vector(aggregate(GPA$Csize ~ dimnames(GPA$coords)[[3]], FUN=mean)[,-1])
names(ind.Csize) <- unique(names(GPA$Csize))
# ind.Csize - These are the individuals Csize data for plotting specimen allometry graphs

#are dimnames identical i.e. will the aligned properly?
dimnames(GPA$coords)[[3]]==names(GPA$Csize)

dimnames(ind.coords)[[3]]==names(ind.Csize)

#Turning into gdf frame and giving names
GPA_mean <-geomorph.data.frame(coords=ind.coords, Csize=ind.Csize)
dimnames(GPA_mean$coords)[[3]] <-dimnames(ind.coords)[[3]]
names(GPA_mean$Csize) <- names(ind.Csize)


```
#Read in classifier file that contains the species name, locomotion type, diet, and phylogenetic clade - 

```{r}

speclist<- read.delim("../Data/Raw/Mars_classifier_list.txt")
rownames(speclist) <-speclist$Specimen

```

# To understand WHAT, running a PCA. To understand WHAT, computing the PCA eigenvalues.

#To understand the main variation in shape between marsupial species I will run a Principle Component Analysis (PCA) on the coordinate data. Using the function plotTangentSpace from the geomorph package, the resulting graph will provide the two PC axes that explain the most variation between species coordinates. To understand the variance of each PC axis, I will run the function pc.sumary$importance to view the eigenvalues. These eigenvalues aid in further analyses.

#Each PC represents a particular aspect of the overall shape variation, 

##would you do a PCA for habitat, diet and clade? 

#### RAN INTO A PROBLEM WITH THIS, WONT SHOW THE SPECIES NAMES
```{r}
#Run PCA
PCA <- plotTangentSpace(GPA_mean$coords, label=dimnames(GPA_mean$coords)[[3]])

#PCA eigenvalues; The low PC eigenvalue shows that one aspect of the overall shape data cannot explain the majority of the variation. Visually the data is displayed across several orthogonal axes  
PCA$pc.summary$importance

#If there is an obvious problem specimen, find out what number specimen it is on the GPA
dimnames(GPA$coords)[[3]]

plotRefToTarget(GPA$coords[,,6], GPA$coords[,,16], method="vector")

```

#PlotRefto target - Function plots shape differences between a reference and target specimen
#vector: a plot showing the vector displacements between corresponding landmarks in the reference and target specimen is shown



# Visualize main differences OF WHAT AND WHY? YOU MIGHT ALSO ADD SOME DESCRIPTION OF THE RESULTS HERE, WHICH YOU CAN LATER PUT INTO RESULTS SECTION.
```{r}

#Below is a starting point for customizing your PlotRefToTarget plots. I recommend playing with this! This then gets fed into plotRefToTarget as per below.
PRTT=gridPar(pt.bg="green", pt.size = 1)

plotRefToTarget(PCA$pc.shapes$PC1min, PCA$pc.shapes$PC1max, method="vector", mag=0.6,gridPars = PRTT)
plotRefToTarget(PCA$pc.shapes$PC2min, PCA$pc.shapes$PC2max, method="vector") #Back to standard grey
```

To prevent confounding in further analyses I tested for allometry 

#TO UNDERSTAND/TEST...., TESTING FOR ALLOMETRY (WHAT ABOUT ALLOMETRY ARE YOU TESTING?)

#Figure out allometry - try to do this yourself, check the geomorph guide here. Is there significant allometry? Can you plot it? Is there significant correlation betwen PC1, 2 or 3 and Allometry? As a proxy for size, use GPA$Csize.Try this, I can help you later tonight if you get stuck.


#CHECK IF ALLOMETRY IS ONLY IN THE "REST OF SKULL" PARTITION

```{r}

Allom<-procD.allometry(coords~Csize, f2=NULL, f3=NULL, logsz=TRUE, data=GPA_mean, iter=10000, print.progress=FALSE)
summary(Allom)

```

#Try to get a stable tree code to work - find the phylogeny, try to read it in. I have some model code for you but try to use google and help files to see if you can read it in.

```{r}
#All 3 analyses (Maximum likelihood (ML), Bayesian, and parsimony) performed in Mitchell et al. (2014) resulted in well-resolved and concordant trees.
#I chose the first tree (ML, without outgroups) due to the use of it in their further analyses

tree=read.nexus("../Data/Raw/Mitchell_pruned_tree.nex")
tree_use <- tree[1]$tree_1

###~~~~~~~CHANGING SPECIES NAME~~~~~~~~~~###
tree_use$tip.label
tree_use$tip.label[166]  
#This shows particular tip label (without the number present this code will provide you with all the tip labels)

names(tree_use$tip.label[NUMBER] <- "New_Species")

names(tree_use$tip.label[5]) <- "Caluromys_derbianus"
names(tree_use$tip.label[1]) <- "Lestoros_inca"
names(tree_use$tip.label[5]) <- "Dendrolagus_inustus"
names(tree_use$tip.label[5]) <- "Philander_andersoni"
names(tree_use$tip.label[5]) <- "Lasiorhinus_krefftii"
names(tree_use$tip.label[5]) <- "Phalanger_mimicus"
names(tree_use$tip.label[5]) <- "Planigale_ingrami"
names(tree_use$tip.label[5]) <- "Sminthopsis_murina"
names(tree_use$tip.label[5]) <- "Sminthopsis_macroura"
names(tree_use$tip.label[5]) <- "Thylamys_elegans"

#to do the namecheck, Csize is easier to navigate to but it is part of the same gdf so that's fine

#NAVIGATE TO THE NAMES FOR THESE NAME CHECKS HAVE A LOOK FURTHER UP IN THE CODE
namecheck=name.check(tree_use,GPA_mean$Csize)

Matchtest=match(tree_use$tip.label,GPA_mean$coords)
length(which(!is.na (Matchtest)))


tree_synch=drop.tip(tree_use,namecheck$tree_not_data)

name.check(tree_synch,gpa_M)

```

#Create two partitions
```{r}
### Import the  partition map
part.gp=as.matrix(read.csv("../Data/Raw/partitions.csv", header=FALSE))

```
TEmporary rought code to make partitions show up 

```{r}
# Utilities based on existing functions

#colouring partition spheres
#@param land_data_partition the landmark data e.g. land_data$cranium
#@param partnames is an optional vector with names for each partition number
#@param PointSize is for changing the size of spheres plotted

WomCrPart is your part.gp

 #provides the numbers of the parts
  PartLevels= unique(part.gp[,2])
  Colours<-rainbow(length(PartLevels))
  Colours <- c("blue", "orange", "green")
  
  ##subset the landmarks according to the partitions
  for(i in 1:length(PartLevels)){
    Part[[i]]<-which (WomCrPart[,2] == PartLevels[[i]])
  }
  
  ##colours the spheres for each partition; Replace WomCrRef with any configuraiont e.g. mean specimen
  open3d()
  for (i in 1:length(PartLevels)){
    spheres3d(SOMETHING_Cords as WomCrRef[Part[[i]],1], WomCrRef[Part[[i]],2], WomCrRef[Part[[i]],3], col=Colours[i], lit=TRUE,radius = PointSize, asp=F)
    
  }
  
}

```

#Compare evolutionary rates of partitions
```{r}
res.evolrate1 <- compare.multi.evol.rates(coords, part.gp, trees[[1]], 
                                          Subset = TRUE, iter = 1000)


```

#

```{r}


```
