---
title: "Marsupial shape and phylogenetics"
author: "Leonie Lange-Hodgson"
date: "22 January 2019"
output: html_document
editor_options: 
  chunk_output_type: inline
---


# load required libraries

#I will be using the following R packages in these analyses; geomorph, ape, plyr, abind, and geiger.

```{r}
library(rgl)
library(RRPP)
library(geomorph)
library(ape)
library(plyr)
library(abind)
library(geiger)
library(caper)

```
#read in coordinates

#Prior to investigating the three predictions of this study, I will input and prepare my data.
```{r}

#RUN LINE BY LINE! LATER DOWN THE LINE ASK THOMAS HOW TO FIX THIS

#This working directory needs to be set for this chunk because otherwise it won't find the files. It is an issue of rmd talking to R itself.
setwd("E:/Github_Projects/Mars-shape/Data/Raw/Coordinates") #Vera's computer
setwd("D:/Github_Projects/Mars-shape/Data/Raw/Coordinates")  #Leonie's computer


filelist <- list.files(path= "../Data/Raw/Coordinates", pattern = "*.txt")

#Next step is to remove the Museum IDs from the specimen names   
  
  tmp <- matrix(unlist(strsplit(filelist, "_")),ncol=3,byrow = TRUE)   

  filelist_species <- paste(tmp[,1], tmp[,2], sep="_")

  
  names <- gsub (".txt", "", filelist) # extracts names of specimens from the file name
  filelist <- paste("../Data/Raw/Coordinates/", filelist, sep="") # rename with path
  coords <- NULL # make empty object that will be filled with 3D array of coordinate data
  for (i in 1:length(filelist)){
    temp  <- read.morphologika(filelist[i]) 
    k <- dim(temp)[1] 
    coords <- rbind(coords, two.d.array(temp)) }
  Data <- arrayspecs(coords, k, 3) 
  dimnames(Data)[[3]] <- filelist_species
  remove(i, filelist, names, k, coords, temp) # clean up environment
  
  #Double check that the 3D info is entered properly
  plot3d(Data[,,4], asp=FALSE)
  text3d(Data[,,4], texts=c(1:58))
  
 
```

#Read in classifier file that contains the species name, locomotion type, diet, and clade


```{r}

speclist<- read.delim("../Data/Raw/Mars_classifier_list.txt")
rownames(speclist) <-speclist$Specimen

```

#Importation of partition map, ensure it's a factor


The landmark dataset will now be split into two partitions; basicranium and the rest of the skull. 

```{r}

### Import the  partition map, ensure it's a factor
part.gp=as.vector(read.csv("../Data/Raw/partitions.csv", header=FALSE))
part.gp=as.factor(part.gp$V1)


```

#Make an image of the partitions (in progress)


```{r}
Dviv <- read.ply("../Data/Dasyurus_viverrinus_ascii.ply")


plot3d(Data[,,7], asp=FALSE)
shade3d(Dviv )



```


#Continuing data preparation, the function 'gpagen' will run a Generalised Procrustes Analysis (GPA). GPA will take the specimen landmarks and superimpose them, thereby removing all the differences in size, orientation and location between each specimen. What remains are landmark coordinates tha provide the shape variation between species.
#This will make it possible to allow me to analyse their shape variation relative to each other


#GPA for all coordinates
```{r}
#Run GPA
GPA_AllSpecimens <- gpagen(Data)


#AVERAGING MULTIPLE SPECIMENS OF ONE SPECIES

#Two of the species in this dataset have multiple specimens which means they must be averaged prior to analysis. Once this is performed, GPA must be run again to incorporate these changes 

#Remember= dim() is the dimensions of an object


# shape data
ind.coords <- aggregate(two.d.array(GPA_AllSpecimens$coords) ~ dimnames(GPA_AllSpecimens$coords)[[3]], FUN=mean)[,-1]
rownames(ind.coords) <- unique(dimnames(GPA_AllSpecimens$coords)[[3]])
ind.coords <- arrayspecs(ind.coords, p=ncol(ind.coords)/3, k=3)
# centroid size data
ind.Csize <- as.vector(aggregate(GPA_AllSpecimens$Csize ~ dimnames(GPA_AllSpecimens$coords)[[3]], FUN=mean)[,-1])
names(ind.Csize) <- unique(names(GPA_AllSpecimens$Csize))
# ind.Csize - These are the individuals Csize data for plotting specimen allometry graphs

#are dimnames identical i.e. will the aligned properly?
dimnames(GPA_AllSpecimens$coords)[[3]]==names(GPA_AllSpecimens$Csize)

dimnames(ind.coords)[[3]]==names(ind.Csize)

#Turning into gdf frame and giving names
GPA_Allmean <-geomorph.data.frame(coords=ind.coords, Csize=ind.Csize)
dimnames(GPA_Allmean$coords)[[3]] <-dimnames(ind.coords)[[3]]
names(GPA_Allmean$Csize) <- names(ind.Csize)


```


#GPA for basicranial landmarks
```{r}
#Subset basicranial landmarks
Data_basi=Data[which(part.gp==2),,]
#double-check that the correct number of landmarks has been subtracted
attributes(Data_basi)

#GPA
GPA_basi <- gpagen(Data_basi)


#AVERAGING MULTIPLE SPECIMENS OF ONE SPECIES

#Two of the species in this dataset have multiple specimens which means they must be averaged prior to analysis. Once this is performed, GPA must be run again to incorporate these changes 

#Remember= dim() is the dimensions of an object


# shape data
basi.coords <- aggregate(two.d.array(GPA_basi$coords) ~ dimnames(GPA_basi$coords)[[3]], FUN=mean)[,-1]
rownames(basi.coords) <- unique(dimnames(GPA_basi$coords)[[3]])
basi.coords <- arrayspecs(basi.coords, p=ncol(basi.coords)/3, k=3)
# centroid size data
basi.Csize <- as.vector(aggregate(GPA_basi$Csize ~ dimnames(GPA_basi$coords)[[3]], FUN=mean)[,-1])
names(basi.Csize) <- unique(names(GPA_basi$Csize))
# basi.Csize - These are the individuals Csize data for plotting specimen allometry graphs

#are dimnames identical i.e. will the aligned properly?
dimnames(GPA_basi$coords)[[3]]==names(GPA_basi$Csize)

dimnames(basi.coords)[[3]]==names(basi.Csize)

#Turning into gdf frame and giving names
GPA_Basimean <-geomorph.data.frame(coords=basi.coords, Csize=basi.Csize)
dimnames(GPA_Basimean$coords)[[3]] <-dimnames(basi.coords)[[3]]
names(GPA_Basimean$Csize) <- names(basi.Csize)

```



#GPA for the REST OF THE SKULL


```{r}

#Subset the rest of the skull's landmarks lms
Data_reskull=Data[which(part.gp==1),,]
#double-check that the correct number of landmarks has been subtracted
attributes(Data_reskull)

#GPA

GPA_reskull <- gpagen(Data_reskull)


#AVERAGING MULTIPLE SPECIMENS OF ONE SPECIES

#Two of the species in this dataset have multiple specimens which means they must be averaged prior to analysis. Once this is performed, GPA must be run again to incorporate these changes 

#Remember= dim() is the dimensions of an object

# shape data
ind.coords <- aggregate(two.d.array(GPA_reskull$coords) ~ dimnames(GPA_reskull$coords)[[3]], FUN=mean)[,-1]
rownames(ind.coords) <- unique(dimnames(GPA_reskull$coords)[[3]])
ind.coords <- arrayspecs(ind.coords, p=ncol(ind.coords)/3, k=3)
# centroid size data
ind.Csize <- as.vector(aggregate(GPA_reskull$Csize ~ dimnames(GPA_reskull$coords)[[3]], FUN=mean)[,-1])
names(ind.Csize) <- unique(names(GPA_reskull$Csize))
# ind.Csize - These are the individuals Csize data for plotting specimen allometry graphs

#are dimnames identical i.e. will the aligned properly?
dimnames(GPA_reskull$coords)[[3]]==names(GPA_reskull$Csize)

dimnames(ind.coords)[[3]]==names(ind.Csize)

#Turning into gdf frame and giving names
GPA_Restmean <-geomorph.data.frame(coords=ind.coords, Csize=ind.Csize)
dimnames(GPA_Restmean$coords)[[3]] <-dimnames(ind.coords)[[3]]
names(GPA_Restmean$Csize) <- names(ind.Csize)



```


#Images for partitions


```{r}
#colouring partition spheres 

 #provides the numbers of the parts
  PartLevels = unique(part.gp[])
  #colour scheme ;-)
  Colours <- c("hotpink", "purple")
  
  #Mesh material
  
 
  #Make mean shape that the points can be plotted on
  Ref=mshape(GPA_Allmean$coords)
  
  #Or, for 3d plotting, call up the coordinates of the mean specimen; remember that the radius of the spheres might need to increase because this is not GPA'ed
  Ref <- Data[,,7]
  
  Part=list()
  ##subset the landmarks according to the partitions
  for(i in 1:length(PartLevels)){
    Part[[i]]<-which (part.gp[] == PartLevels[[i]])
  }
  
  ##colours the spheres for each partition on the mean shape
  
  open3d()
  
  for (i in 1:length(PartLevels)){
    spheres3d( Ref[(Part[[i]]),]*1000, col=Colours[i], lit=TRUE, radius = 900, asp=F)
    
  }

  shade3d (Dviv, color="grey")
  
```

#To understand the main variation in shape between marsupial species I will run a Principal Component Analysis (PCA) on the coordinate data. Using the function plotTangentSpace from the geomorph package, the resulting graph will provide the two PC axes that explain the most variation between species coordinates. To understand the variance of each PC axis, I will run the function pc.sumary$importance to view the eigenvalues. These eigenvalues aid in further analyses.

#Each PC represents a particular aspect of the overall shape variation, see more in the chunk

##would you do a PCA for habitat, diet and clade? 

```{r}
#Checking if all specimens are read in properly with their Csizes
PCA_all <- plotTangentSpace(GPA_Allmean$coords, label=dimnames(GPA_Allmean$coords)[[3]])
summary(PCA_all$pc.scores)

plot(PCA_all$pc.scores[,1]~GPA_Allmean$Csize ); text(PCA_all$pc.scores[,1]~GPA_Allmean$Csize, labels=names(GPA_Allmean$Csize))


#Run PCA
PCA_mean <- plotTangentSpace(GPA_Allmean$coords, label=dimnames(GPA_Allmean$coords)[[3]])

plot(PCA_mean$pc.scores[,1]~GPA_Allmean$Csize ); text(PCA_mean$pc.scores[,1]~GPA_Allmean$Csize, labels=names(GPA_Allmean$Csize))

#If there is an obvious problem specimen, find out what number specimen it is on the GPA
dimnames(GPA_Allmean$coords)[[3]]

plotRefToTarget(GPA_Allmean$coords[,,1], GPA_Allmean$coords[,,48], method="vector")


```

#PlotRefto target - Function plots shape differences between a reference and target specimen
#vector: a plot showing the vector displacements between corresponding landmarks in the reference and target specimen is shown


# Visualize main differences OF WHAT AND WHY? YOU MIGHT ALSO ADD SOME DESCRIPTION OF THE RESULTS HERE, WHICH YOU CAN LATER PUT INTO RESULTS SECTION.
```{r}

#Below is a starting point for customizing your PlotRefToTarget plots. I recommend playing with this! This then gets fed into plotRefToTarget as per below.
PRTT=gridPar(pt.bg="green", pt.size = 1)

plotRefToTarget(PCA_mean$pc.shapes$PC1min, PCA_mean$pc.shapes$PC1max, method="vector", mag=0.6,gridPars = PRTT)
plotRefToTarget(PCA_mean$pc.shapes$PC2min, PCA_mean$pc.shapes$PC2max, method="vector") #Back to standard grey
```

#TREE PHYLOGENY 

#names(tree_use$tip.label[NUMBER] <- "New_Species") #What I need to write to change the name of a particular tip

```{r}
#All 3 analyses (Maximum likelihood (ML), Bayesian, and parsimony) performed in Mitchell et al. (2014) resulted in well-resolved and concordant trees.
#I chose the first tree (ML, without outgroups) due to the use of it in their further analyses

tree=read.nexus("../Data/Raw/Mitchell_pruned_tree.nex")
tree_use <- tree[1]$tree_1

###~~~~~~~CHANGING SPECIES NAME~~~~~~~~~~###
tree_use$tip.label
tree_use$tip.label[5]  
#This shows particular tip label (without the number present this code will provide you with all the tip labels)

tree_use$tip.label[5] <- "Caluromys_derbianus"
tree_use$tip.label[1] <- "Lestoros_inca"
tree_use$tip.label[178] <- "Dendrolagus_inustus"
tree_use$tip.label[30] <- "Philander_andersoni"
tree_use$tip.label[124] <- "Phalanger_mimicus"
tree_use$tip.label[66] <- "Planigale_ingrami"
tree_use$tip.label[67] <- "Sminthopsis_murina"
tree_use$tip.label[39] <- "Thylamys_elegans"
tree_use$tip.label[20] <- "Marmosa_demerarae"
tree_use$tip.label[19] <- "Marmosa_alstoni"
tree_use$tip.label[130] <- "Petaurus_australis"
#to do the namecheck, Csize is easier to navigate to but it is part of the same gdf so that's fine

#NAVIGATE TO THE NAMES FOR THESE NAME CHECKS HAVE A LOOK FURTHER UP IN THE CODE
namecheck=name.check(tree_use,GPA_Allmean$Csize)

Matchtest=match(tree_use$tip.label,GPA_Allmean$Csize)
length(which(!is.na (Matchtest)))


tree_synch=drop.tip(tree_use,namecheck$tree_not_data)

name.check(tree_synch,GPA_Allmean$Csize)

```


Allometry in geometric morphometrics refers to size-related changes of morphological traits. 
e.g. does brain size increase as body size increases?
looking at overall shape however

#Csize has an effect on shape of the landmarks

##When analysing the allometry of the remaining landmark on the skull the results showed the effect size of Csize is quite small however there is a fairly significant p-value suggesting that Csize does have an effect on shape

```{r}
#Geomorph update 3.1.0 on the 27th March removed procD.Allometry so using the function procD.lm instead. 
Allom<-procD.lm(coords~Csize, logsz=TRUE, data=GPA_Allmean, iter=10000, print.progress=FALSE)
summary(Allom)


AllBasi<-procD.lm(coords~Csize, data=GPA_Basimean, iter=1000, print.progress=FALSE)
summary(AllBasi)

plotAllometry(AllBasi, size=GPA_Basimean$Csize, method = "RegScore")

AllRest<-procD.lm(coords~Csize, logsz=TRUE, data=GPA_Restmean, iter=10000, print.progress=FALSE)
summary(AllRest)

```



#Compare evolutionary rates of partitions and phylogenetic signal



Evolutionary rates

#Phylogenetic signalling


```{r}
#### SHAPE RATE ANALYSES
### Compare evolutionary rates between partitions
# Calculate rates for each partition


parevo.rate <- 
  compare.multi.evol.rates(GPA_Allmean$coords,  part.gp, tree_synch,iter = 1000)
summary(parevo.rate)

# Does phylogenetic signal differ? do for the other two as well and csize

physignal(GPA_Allmean$coords, tree_synch, iter = 1000)

physignal(GPA_Basimean$coords, tree_synch, iter = 1000)

physignal(GPA_Restmean$coords, tree_synch, iter = 1000)

```

#PGLS for Diet and Locomotion (look at all three GPAs)


```{r}
#Combine the GPA geomorph dataframe with the two columns I want from the speclist data frame

#Do this for each of the GPA dataframes


Allandlist<-mutate(GPA_Allmean, diet=speclist$Diet, locomotion=speclist$Locomotion)

Basiandlist<-mutate(GPA_Basimean, diet=speclist$Diet, locomotion=speclist$Locomotion)

Restandlist<-mutate(GPA_Restmean, diet=speclist$Diet, locomotion=speclist$Locomotion)


#First look at diet and locomotion for all landmarks


Alldiet_inter<-procD.pgls(coords ~ diet, tree_synch, data = Allandlist, iter = 999)
summary(Alldiet_inter)

AllLoco_add<-procD.pgls(coords ~ locomotion, tree_synch, data = Allandlist, iter=999)
summary(AllLoco_add)


# Next look at basicranium landmarks

Basidiet_inter<-procD.pgls(coords~diet, tree_synch, data = Basiandlist, iter = 999)
summary(Basidiet_inter)

BasiLoco_inter<-procD.pgls(coords~locomotion, tree_synch, data = Basiandlist, iter=999)
summary(BasiLoco_inter)

plot3d(Basiandlist$coords[,,8], asp=TRUE); text3d(Basiandlist$coords[,,8], texts=c(35:58))

                                            
                                                   
#Then at the rest of the skull landmarks

RestDiet_inter<-procD.pgls(coords~diet, tree_synch, data = Restandlist, iter = 999)
summary(RestDiet_inter)

RestLoco_add<-procD.pgls(coords~locomotion, tree_synch, data = Restandlist, iter=999)
summary(RestLoco_add)

#Does the locomotion signal also show in the main variation as per PC1

PCA <- plotTangentSpace(Allandlist$coords)

plot(PCA$pc.scores[,1]~ as.numeric (Allandlist$locomotion))


plot(PCA$pc.scores[,1]~ as.numeric (Basiandlist$locomotion))
plot(PCA$pc.scores[,1]~ as.numeric (Restandlist$locomotion))



````

